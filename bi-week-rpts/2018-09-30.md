---
layout: default
---

# RISC-V 双周简报 (2018-09-30)

要点新闻：

## RV新闻

## 技术讨论

### RISC-V如何加载一个立即数

这个看似不起眼的问题实际上有些复杂。`lui`指令可以将20位的立即数加载到目标寄存器的高20位，通过与其他的I型指令或S型指令组合可以加载一个32位的立即数或读写某地址上的内容。

但是在[riscv-elf-psabi-doc](https://github.com/riscv/riscv-elf-psabi-doc/blob/master/riscv-elf.md)中的`Absolute Addresses`一小节中有这样的一段描述：

> 32-bit absolute addresses in position dependent code are loaded with a pair of instructions which have an associated pair of relocations: `R_RISCV_HI20` plus `R_RISCV_LO12_I` or `R_RISCV_LO12_S`.
>
> The `R_RISCV_HI20` refers to an `LUI` instruction containing the high 20-bits to be relocated to an absolute symbol address. The `LUI` instruction is followed by an I-Type instruction (add immediate or load) with an `R_RISCV_LO12_I` relocation or an S-Type instruction (store) and an `R_RISCV_LO12_S` relocation. The addresses for pair of relocations are calculated like this:
>
> - `hi20 = ((symbol_address + 0x800) >> 12);`
> - `lo12 = symbol_address - (hi20 << 12);`
>
> The following assembly and relocations show loading an absolute address:
>
> ```
>      lui  a0,%hi(symbol)     # R_RISCV_HI20 (symbol)
>      addi a0,a0,%lo(symbol)  # R_RISCV_LO12 (symbol)
> ```

注意到`hi20`在计算中加上了`0x800`。按照一般的思路，`lui`加载高20位，`addi`正好可以补充低12位。然而`addi`进行的有符号加法，如果`imm`的最高位为`1`，那么`addi`将会认为它是一个负数。

`+0x800`的目的是如果立即数的第11位（最低位为第0位）是1，那么就对高20位+1进行补偿，这样计算得到的`lo12`正好是带符号的。为了更好地理解这一过程，有如下推导：

设32位的立即数由`hi`和`lo`拼接组成，分别为20位和12位，即`imm=hi·lo`

如果`lo`的最高位为0，则`hi20=(imm+0x800)>>12=hi`，`lo12=imm-(hi20<<12)=imm-(hi<<12)=lo`

此时加载的指令序列即为

```assembly
lui  a0,hi
addi a0,a0,lo
```

如果`lo`的最高位为1，则`hi20=(imm+0x800)>>12=hi+1`，

`lo12=imm-(hi20<<12)=imm-((hi+1)<<12)=hi·lo-((hi+1)·{12'b0})={20'b1}·lo` 

此时加载的指令序列为

```assembly
lui  a0,hi+1
addi a0,a0,lo
```

由于`lo`的最高位为1，因此此时`lo`被视作一个负数，即`{20'b1}·lo`，而高20位在原来的基础上增加了1，正好可以将`lo12`的高20位`{20'b1}`抵消。

- [riscv-elf-psabi-doc](https://github.com/riscv/riscv-elf-psabi-doc/blob/master/riscv-elf.md)

作者：John Wang


## 代码更新

## 安全点评

### 内存、代码和指针的已有安全技术搜集

Arm的指针加密技术(PA, Pointer Authentication)随着苹果 iOS 12 进入了产品使用阶段，
加上最近[ARM宣布](https://community.arm.com/processors/b/blog/posts/arm-a-profile-architecture-2018-developments-armv85a)
在其Armv8.5-A中使用内存标签技术和跳转目标限定(BTI, Branch Target Indicator)技术，
促使Michael Clark在isa-dev列表上总结关于内存、代码和指针的已有安全技术(prior art)，
希望能在将来制定一个非商业保护的开放安全标准。
讨论中谈及了以下几个方向：

- **二进制代码的安全转译: [Crypto Binary Translation](https://github.com/michaeljclark/rv8/blob/master/doc/src/bintrans.md)。**
动态二级制转译(Dynamic binary translation)是虚拟技术的一种，通过动态翻译并执行二进制代码实现不同指令集编译的程序在其他架构上的执行，
运行时优化等等功能。
如果动态二级制转译工具可以在转译时随机化代码中的内存分布、代码块分布、寄存器分配、系统调用表分布等等，
则可以进一步加扰被执行的代码，从而给运行时攻击增加难度。
不过，也有研究认为，即使没有任何的静态分析支持，仅通过运行时的代码分析，也能够完成攻击，被称为盲攻击([Blind ROP Attack](http://www.scs.stanford.edu/brop/bittau-brop.pdf))。

- **二进制代码混淆: [Binary Code Obfuscation](https://www.ics.uci.edu/~perl/automated_software_diversity.pdf)。**
和二进制转译时随机化类似，二进制代码混淆一般依赖于编译器，对二进制代码进行随机化。
可随机化的内容包括指令本身、代码分布、数据分布、堆结构等等。

- **指针加密: [Cryptographically Enforced Control Flow Integrity](https://arxiv.org/pdf/1408.1451.pdf)**
控制流劫持攻击往往需要修改代码指针或者和代码指针相关的数据指针。
通过对这些关键指针进行加密，然后在使用指针(dereference)时检查指针是否能正确解密，来防止攻击者篡改指针，从而阻止攻击。

- **宽指针: [Embedding Metadata within Pointer](http://www.crash-safe.org/assets/fatptr_ccs2013.pdf)**
很多安全措施都需要标注与安全相关的指针。
在64位机器中，指针往往只占用39位或48位的低位空间，剩下来的16到25位的高位空间往往不是全0就是全1。
通过将安全所需的附加数据存放于这些没有使用的高位中，则可以在不增加存储的情况下扩展安全措施。
不过，RISC-V现在并没有计划将类似方案加入到指令集中(见2016年9月的[相关讨论](https://groups.google.com/a/groups.riscv.org/d/msg/isa-dev/Pm9mso-urM8/8v8733ObDAAJ))。
主要的顾虑来自于该方案的可扩展性。
即使现在普遍认为48位寻址已经足够大(256TB)，将来还是会有更大的寻址要求，比如说内存和存储统一寻址的计算机集群或者稀疏寻址(sparse address)。
如果将48位寻址的高16位定义为安全metadata数据，在将来支持56位寻址的时候，地址位则和安全metadata重叠，产生不兼容问题。

当然，以上几点只是在邮件列表中被提及的技术，
并不能完全囊括所有的相关安全技术。
其他常见的安全措施包括强制CFI、影子栈、边界检查、指令加密等等。

具体讨论见[isa-dev邮件列表](https://groups.google.com/a/groups.riscv.org/d/msg/isa-dev/dldr_7j6t8k/KI0HUqHSCQAJ)。

## 微群热点

## 实用资料

## 行业视角

## 市场相关

## CNRV社区活动

## CNRV网站更新

## 会议征稿


## 暴走事件

### 2018年10月

- 2018年10月18日, RISC-V Day Tokyo将在Keio University举办，大会议程已经公布。[注册网站](https://tmt.knect365.com/risc-v-day-tokyo/)

### 2018年12月

- 2018年11月13-14日 [Chisel Community Conference](https://chisel.eecs.berkeley.edu/blog/?p=200)将会在湾区举办，会议开放Call for Paper，地点还没有完全确定
- 2018年12月3-5日 [RISC-V Summit in Santa Clara (Dec. 3-5)](http://cts.businesswire.com/ct/CT?id=smartlink&url=https%3A%2F%2Ftmt.knect365.com%2Frisc-v-summit%2F&esheet=51792917&newsitemid=20180423005251&lan=en-US&anchor=RISC-V+Summit+in+Santa+Clara&index=4&md5=88ca965085b5b1b9b6ea996333f27e44)，大会议程已经公布 [Agenda](https://tmt.knect365.com/risc-v-summit/agenda/2)

## 招聘简讯

_CNRV提供为行业公司提供公益性质的一句话的招聘信息发布，若有任何体系结构、IC设计、软件开发的招聘信息，欢迎联系我们！_

----

整理编集: 宋威、黄柏玮、汪平、林容威、傅炜、巍巍、郭雄飞、黄玮、李健

特别感谢: John Wang

----

**欢迎关注微信公众号CNRV，接收最新最时尚的RISC-V讯息！**

![CNRV微信公众号](/assets/images/cnrv_qr.png)

----

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/80x15.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a>进行许可。

