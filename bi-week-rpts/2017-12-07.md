---
layout: default
---

# RISC-V 双周简报 (2017-12-07)

要点新闻：


## RV新闻


## 技术讨论

### RISC-V 内存模型草案

nVidia的Daniel Lustig在月初公布了RISC-V内存模型的最新版草案并征求意见。
计划在意见反馈之后，将内存模型草案提交RISC-V基金会讨论，并融入正式标准。
关心内存模型的同学请阅读草案（见下面链接邮件的附件）并在isa-dev邮件列表上提出意见。

这次的草案进一步细化了RISC-V内存模型的定义，包括支持的种类，各种内存模型中具体内存操作的顺序（即硬件必须遵守而不能调整的内存访问顺序）。
RISC-V内存模型支持两种模式：类似ARM和PowerPC的弱内存模型RVWMO和类似Intel x86的强内存模型RVTSO。
一个架构支持两种内存模型是比较奇怪的，大多数的架构只支持一种内存模型。
RISC-V的大部分使用者（包括nVidia，SiFive和大部分ARM处理器的使用者）其实更支持使用类似ARM的弱内存模型RVWMO，即使用fence来显式地强制需要按序执行的内存操作，而让处理器和微架构确定其他的内存访问顺序以提高性能和降低功耗。
然而，有一部分地x86使用者希望能通过简单重编译地方式将原有跑在x86处理器地程序移植到RISC-V处理器。
软件上修改内存模型需要手动修改代码，现在还不能由编译器自动完成。
这就导致了重编译地程序默认硬件使用TSO地内存模型。
作为折衷，RISC-V内存模型草案规定：
- 处理器硬件实现的内存模型不能比RVWMO更弱，但是可以选择性的变强，可以选择实现RVTSO。
- 软件设计应当尽可能使用RVWMO模型。所有RISC-V的库、编译器都将使用RVWMO模型。
- 软件可以使用RVTSO模型编译，但是必须在ELF标注TSO模型。以这种方式编译的程序只能运行在实现RVTSO的处理器上。
- 使用RVTSO模型编译的程序可以链接RVWMO模型的库。RVWMO模型的fence指令在RVTSO模型的处理器上当作NOP执行。

具体软件硬件可组合的方式：

|             | RVWMO的处理器 | RVTSO的处理器  |
| ---------:  |  :----:       | :---:         |
| **RVWMO的程序**  | 正常高效执行  | 正常低效执行    |
| **RVTSO的程序**  | 执行出错      | 正常执行       |

讨论还在继续中：RISC-V isa-dev 邮件列表 [https://goo.gl/5o8rpk](https://groups.google.com/a/groups.riscv.org/d/msg/isa-dev/hKywNHBkAXM/wLwNIEpDAwAJ)

### 由硬件控制的页表A/D标志位引发的思考

（小编：这个讨论有点发散，不得不惊叹于体系结构还是有那么多令人纠结的惊人的细节）
RISC-V priv spec在页表的叶子节点（也就是具体内存页的页表项）上有A(已访问)和D(已修改)两个标志位。
RISC-V可以支持硬件或者软件管理的A/D控制。
现在大部分的处理器和操作系统都使用软件方式，即：出现访问一个页而A==0的时候或修改一个页而D==0的时候，TLB引发页错误要求软件修改标志位。
鉴于该操作可能会很频繁并影响新能，处理器可以选择使用硬件处理，即TLB直接修改页表。这里就引出了好几个问题：

- 如果操作系统不知道怎么办？操作系统有可能会软件缓存页表标志位，完全硬件处理则导致软件硬件不一致。这个问题还算好解决，硬件处理A/D标志位的处理器需要在device tree中说明。

- 为什么只有叶子节点才有A/D标志位？中间页表项也可以设置A/D标志位。这样很可能可以在页表的第二级就发现缺页。但是维护非叶子节点的A/D标志位很复杂！

- 如果硬件修改标志位，TLB会不会误改？比如说ITLB的预取指和深流水线。如果解决该问题，那么所有TLB修改就是个fence了。如果是fence，hypervisor（虚拟层）的行为就不确定了，就不能严格重跑了（hypervisor的一个重要功能）。（小编：这些问题，现在看起来，还是很无解）

isa-dev上的讨论：[https://goo.gl/TywzWt](https://groups.google.com/a/groups.riscv.org/d/msg/isa-dev/0aIYw-W0tl4/eAXB_tXRBwAJ)

### 有副作用的NOP要不要被定义成非法指令？

这是一个有趣的问题。
举个例子，`SC rd, rs1, rs2`，该指令会检查之前`LR`指令加上的锁是否完好，如果完好，则将`rs2`的值写入`rs1`所指向的内存，用`rd`返回1，
否则返回0并不执行写操作。
可是，如果`rd`是常置0的寄存器`x0`呢？按标准定义，如果锁完好，那么写操作将会执行，但是`x0`不能被赋值，所以返回值仍然是0，软件看见的原子操作失败。
显然，一个正常的编译器不会生成这样的代码。

于是，有人提问:

> 应该把这条指令定义为非法指令吗？这样该指令就可以以后被扩展为其他指令了啊。

的确啊，该指令没有什么合法用途，完全浪费指令空间啊。
可是，RISC-V的产生就是为了设计一个对硬件高效同时软件也高性能的指令集。
指令集的一个基本设计思路就是避免将RISC逐步变成一个CISC。
这也是为什么条件执行、多寄存器压栈等等指令都没有被标准指令级采纳的原因。
如果定义该指令为非法指令，硬件上就必须把它当作一个特殊情况处理。
这样的特殊情况多了，RISC-V就变成"CISC-V"了。

- 邮件列表上的讨论：[https://goo.gl/yhpu5V](https://groups.google.com/a/groups.riscv.org/d/msg/isa-dev/eaNx93Dm9WI/7zE7e1YUAwAJ)

### AXI4Deinterleaver的用途

Rocket-Chip提供了一个叫做AXI4Deinterleaver模块。该模块用于重排从AXI总线到TileLink总线的突发报文。
AXI总线允许两个多传输周期的突发报文互相交叠子周期的传输（利用报文的id区分），但是TileLink则不允许一个突发报文被其他报文打断。
为了解决该协议冲突，AXI4Deinterleaver则对多个并发的突发报文经行缓冲再串行传输。

- Rocket-Chip的issue \#1141: [https://git.io/vbGn7](https://github.com/freechipsproject/rocket-chip/issues/1141)


## 代码更新

## 安全点评

## 微群热点

## 实用资料

## 行业视角

## 市场相关


## CNRV社区活动

## CNRV网站更新


## 暴走事件

### 十二月

+ [RISC-V Day 2017 Tokyo](https://riscv.tokyo/2017/10/07/%E6%9C%80%E5%88%9D%E3%81%AE%E3%83%96%E3%83%AD%E3%82%B0%E6%8A%95%E7%A8%BF/)  2017年12月18日，在东京会有一场跟 RISC-V有关的活动，由日本SHC公司主办。SHC公司也是基金会的其中一个成员。Esperanto, SiFive, Andes, RedHat等公司的人员都会参加并给演讲。

### 二月

+ [FOSDEM'18](https://fosdem.org/2018/) 2018年2月3-4日，FOSDEM (Free and Open Source Developers’ European Meeting)将在比利时的布鲁塞尔举行。

+ [PULP WORKSHOP AT HPCA2018](http://pulp-platform.org/hpca2018) 2018年2月25日，在维也纳的HPCA中，会有一场跟Pulp 有关的workshop。PULP小组会介绍PULP最新的发展，和他们未来的走向，包括  PULP-CAPI (Coherent Accelerator Processor Interface) 和 Ariane （Next generation of 64-bit RISC-V implementations）等。详情可参考 pulpino mailing list 中的 < PULP newsletter - 4Q2017 >。


## 招聘简讯

_CNRV提供为行业公司提供公益性质的一句话的招聘信息发布，若有任何体系结构、IC设计、软件开发的招聘信息，欢迎联系我们！_

----

整理编集: 宋威、黄柏玮、郭雄飞


----

**欢迎关注微信公众号CNRV，接收最新最时尚的RISC-V讯息！**

![CNRV微信公众号](/assets/images/cnrv_qr.png)

----

<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/"><img alt="知识共享许可协议" style="border-width:0" src="https://i.creativecommons.org/l/by-nc-sa/3.0/cn/80x15.png" /></a><br />本作品采用<a rel="license" href="http://creativecommons.org/licenses/by-nc-sa/3.0/cn/">知识共享署名-非商业性使用-相同方式共享 3.0 中国大陆许可协议</a>进行许可。

