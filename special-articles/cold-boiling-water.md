## 给开源架构兑点儿白开

近来开源架构这话题着实挺火，尤其是RISC-V，感觉哪儿都有它。开源架构早就不是什么新鲜事儿了，丫RISC-V又是打哪儿冒出来的？

说起开源指令集，Power和SPARC经常被人们提起，但Power和SPARC从服务器和工作站发展而来，指令集相对庞大。去看看Power的指令手册[1]，900来条指令，用了18页才写完，需要非常有实力、财力和积累的厂商。这不明摆着就是打这“开源”的旗号等着你花钱去买“技术转移”么？SPARC也不是省油的灯[2]，指令也好几百条，但可别忘了还有操作系统和软件呐，硬件做完了，软件工具链啥的出了问题，Oracle愿意真心帮你解决？这俩老爷爷被国内无知的媒体吵了一轮又一轮，说实话，走都走不动了。

那RISC-V有啥区别呢？模块儿化不得不提，最简单的RV32I只有40条指令，想功能多点就用其他指令模块，像拼积木一样，用啥拿啥，要啥有啥，没啥造啥。有点能力的大学生几个月就能做一个[3]，难度下降了，再配合现成的工具链啥的，很多有能力厂商都根据自己的需求自己做一个。

说完这个，很多人就开始担心碎片化这个问题。过去ARM为了防止碎片化，严格禁止用户修改指令集，这的确成就了ARM。但是RISC-V解决的思路并不是严格限制，像大禹治水一样，不是到处垒坝，靠的是疏导。这个体现在以下两个方面：首先，前面提到的模块化指令集，让厂商在实现的时候能够根据自己的需求选择标准指令集组合，厂商完全没有必要为不兼容付出额外的成本。其次，指令集里预留好了大量的定制指令空间，指令长度从16比特到1024比特理论上都支持，这些空间就是专门给定制处理器的厂商实现自己的指令集的。这样一来，基本的软件都能兼容，遇到定制指令集，厂家提供预先设计好的函数库就能在很好地保证效率的同时不失兼容性。可以说过去ARM/Intel啥都不让你做，如今有了RISC-V，妹妹你放心大胆的往前走。

这时候你又说了，RISC-V架构简单，面积小功耗低，MIPS不也一样么？其实啊，在CPU设计里，指令集看似是最简单的，但其实想把简单的事情做好才是最难的。一方面，RISC-V生的晚，得算10后，这就能让它吸取很多前辈失败的经验教训，比如寄存机窗口啊、超长指令字啥的，很多坑都前人都踩过一遍了。还有，别看指令集就是那些个寄存器数量、分支跳转啊、Load/Store之类的，可要想设计一个又高效，代码密度又高的指令集可不是那么容易。但目前为止，RISC-V这个“学院派”们做出来的指令集，表现还是很不错的。就以很重要的指令密度这个指标来讲做的和x86\_64和ARMv8不相上下[4]。指令集能够保持高水准，后面厂商的技术能力就不会受到限制，要知道，自身能力才是关键。

关于RISC-V的设计水平到底怎样，David Ditzel应该最有话语权，他曾是早期的SPARC架构师，后创过一公司，叫全美达。当年把Linus和鲍尔默拉一块儿用RISC架构搞了个X86 CPU，一度让Intel差点跌落神坛。这哥们儿前几年评估了RISC-V，越玩儿越觉得这东西不简单，最后的评测的结果是，和ARM/MIPS/SPARC相比，毫不逊色[5]。之后他就果断创业开搞高性能RISC-V处理器了。

说完技术，就得聊聊钱的事儿了。尽管这些个年Arm为了走量的确降低了门槛，但其实费用也不低，Cortex-M0和Cortex-M3尽管可以用几万美元就拿到授权，可是反过来却要收高昂的版税，而且还要按照芯片成品价抽，用M0和M3的芯片多为低成本芯片，这版税直接影响利润啊。过去，这钱你不交也没办法，因为你要是用一些个小众的CPU，生态是个大问题，ARM背后的整个生态是个重要的背书。但RISC-V看着很快就要改变这个局面，各大第三方厂商都开始纷纷支持RISC-V，从商业指令仿真器到高级调试跟踪工具应有尽有。

尽管苹果、高通、三星这些厂商很早就买了架构授权，但是你会发现至少高通和三星很早就加入RISC-V基金会，这些有自研CPU能力的大厂不出5年，我相信就能够随着生态系统的全面完善而开始推出自己的RISC-V处理器。

很多人觉得就算架构免费，但是基于这个架构的CPU实现总是要收钱的吧。这话一点儿没错，CPU IP厂商针对不同的领域开发CPU然后卖给有意向的客户，然后收取相应费用。但这是不是说就和Arm这些厂商没有区别呢？其实不完全是，以SiFive为例，目前的授权费用是30-50万美元，能得到一个类似M4-M7的核心，但是和ARM的不同的是，只要License Fee，不收版税。但其实，SiFive CPU Core的基础Rocket是完全开源的，尽管和商业版本有少量区别，但是对于有一定技术能力的公司，基于这个核心定制出自己的核完全没有问题。一个可喜的状况是，目前市面上已经有大量开源的CPU可供选择，而且大部分都以非常宽松和商业友好的许可证发布。

开源架构每隔几年就出一新东西，然后总能带动起一批国内厂商开发自主创新处理器，但是这次有点不一样，不一样在哪儿呢？就是这次推动国内浪潮一批国内企业很多都是民营私营企业，公司的参与程度也一点儿也不比科研院所差，比如很早就加入基金会里的乐鑫、中天微等，而不像过去都是国家和地方政府资助的几个独苗，做的也都是桌面和高规格的处理器。这个事实的背后必然是深刻的产业和市场化的商业行为。

不论是Intel还是Arm，他们的成功绝不是仅仅因为技术。Intel不只是有傲视群雄的Fab和研发团队，没有Wintel联盟这些商业决策它一样可能完蛋。Arm做了几十年的低功耗处理器，可没有创造性的IP核授权商业模式，也一样会被打败。如果说未来会出现下一个在这个领域成功的巨头，那么它绝不是照搬Intel和ARM的商业模式，一定是因为它商业模式和技术进步上都取得了显著的优势才能成功。记住，你并不需要“取代”x86或者ARM，一旦你找到了二次元的入口，那么在这个新的次元里，根本就没有x86和ARM这两个对象。

指令集架构并不昂贵，昂贵的是打通上下的生态系统。OpenRISC可以说是个不算差的指令集，但是在生态系统上，因为没有持续的投入，所以10多年来都没有进入各大工具链的主线。RISC-V看似和
OpenRISC很像，但从2014年发布这短短的4年里，已经相继被Linux/gcc/glibc/binutils/gdb/qemu等并入官方主线。RISC-V能够用仅仅几年做到OpenRISC十几年没做到的，是因为RISC-V基金会和会员们共同的推动。可以说这些厂商组成的联合团队能够媲美曾经的IBM和Sun的全职团队，否则生态环境不会这么快成熟起来。

有了生态系统的飞速进展，众多厂商都能够从中得到好处。活跃的社区和众多开源核心，又极大的降低了厂商们的开发门槛。然后厂商的积极参与又能够继续推动生态系统的发展，最终形成正反馈。

有人说从一个指令集出现到得到成熟广泛的应用，要十几年。如果说是实现一个IBM Power或者SPARC或者x86这样的指令集的CPU的话，我觉得你说的没错，没点儿积累的确起不来。但是RISC-V因为模块化，因为足够简单，因为开源，因为很早就能提供完整的生态，就真的用短短几年做出了一些成果。以SiFive为例，去年发布的FE310只是个MCU级别的芯片，今年初就已经推出了4+1核可以运行Linux的SoC。还有在NVidia内部使用的RISC-V CPU估计也很快就要进入到下一代显卡中作为控制核心。

换个角度说，过去在PC主导的时代，我们真心得担心碎片化带来的诸多不利影响。如今，在IoT即将迎来爆发的时代，我们需要的是多种多样的定制化处理器和芯片，来完成数据采集、低功耗、无线通信等诸多不同的工作任务。需求越差异化，开源工具越流行，上层软件越平台无关，指令集碎片化所带来的影响就越小。这个趋势是很明显的，时代不同了。

以上几点拙见！

- [1] [Power ISA v3.0B March 29, 2017](https://ibm.ent.box.com/s/1hzcwkwf8rbju5h9iyf44wm94amnlcrv)
- [2] [Oracle SPARC Architecture 2015](http://www.oracle.com/technetwork/server-storage/sun-sparc-enterprise/documentation/sparc-architecture-2015-2868130.pdf)
- [3] 大学生设计RISC-V CPU两则: [kamikaze](https://github.com/rgwan/kamikaze), [iFMRT RISC-V](https://github.com/iFMRT/Graduation-Project-2012/tree/base)
- [4] [Design of the RISC-V Instruction Set Architecture](https://people.eecs.berkeley.edu/~krste/papers/EECS-2016-1.pdf)
- [5] [Another RISC-V Religious Conversion](https://www.eejournal.com/article/another-risc-v-religious-conversion/)

作者：郭雄飞
